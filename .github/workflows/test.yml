# Copyright 2020-2022 Bj√∂rn Kautler
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: "Build and Test"
on:
  "push": null
  "pull_request": null
  "schedule":
  - cron: "0 0 * * *"
jobs:
  "build":
    name: "Build"
    runs-on: "windows-latest"
    steps:
    - name: "Configure Git"
      run: "git config --global core.autocrlf input"
    - name: "Checkout"
      uses: "actions/checkout@v2"
    - name: "Build"
      uses: "burrunan/gradle-cache-action@v1"
      with:
        "arguments": "build --info --stacktrace --scan"
        "debug": "false"
        "concurrent": "true"
        "gradle-dependencies-cache-key": "buildSrc/**/Versions.kt"
    - name: "Save built artifacts to cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
  "test_invalid_distribution":
    name: "Test \"${{ matrix.distribution.label }}\" distribution on ${{ matrix.environment\
      \ }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
      continue-on-error: true
    - name: "Test - action should fail if an invalid distribution is given"
      run: "if '${{ steps.execute_action.outcome }}' NEQ 'failure' exit 1\n"
      shell: "cmd"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "id": "invalid"
          "label": "invalid"
        - "id": ""
          "label": ""
        - "id": null
          "label": "null"
      fail-fast: false
  "test_default_distribution":
    name: "Test default distribution on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action"
      name: "Execute action"
      uses: "./"
      with:
        "update": "true"
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should be available as custom shell"
      run: ":\n"
      shell: "wsl-bash {0}"
    - id: "wrapper_should_fail_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if the script fails (provocation)"
      run: "false\n"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if the script fails (verification)"
      run: "IF '${{ steps.wrapper_should_fail_provocation.outcome }}' NEQ 'failure'\
        \ EXIT /B 1\n"
      shell: "cmd"
    - id: "set_e_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if one of the commands fails (provocation)"
      run: "false\n:\n"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if one of the commands fails (verification)"
      run: "[ '${{ steps.set_e_provocation.outcome }}' == 'failure' ] || exit 1\n"
      shell: "wsl-bash {0}"
    - id: "set_u_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if an undefined variable is used (provocation)"
      run: "$foo"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if an undefined variable is used (verification)"
      run: "[ '${{ steps.set_u_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - id: "set_pipefail_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if any command in a pipe fails (provocation)"
      run: "false | true"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if any command in a pipe fails (verification)"
      run: "[ '${{ steps.set_pipefail_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - the default distribution should be correct"
      run: "wslconfig.exe /list | iconv -f UTF-16LE -t UTF-8\n[[ \"$(wslconfig.exe\
        \ /list | iconv -f UTF-16LE -t UTF-8)\" == *${{ matrix.distribution.wsl-id\
        \ }}\\ \\(Default\\)* ]]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distribution.match-pattern }} ]]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - multi-line commands should not be disturbed by CRLF line endings"
      run: ": # this comment catches the CR if present\n! grep -q $'\\r' \"$0\" #\
        \ this comment catches the CR if present\n"
      shell: "wsl-bash {0}"
    - id: "no_script_file_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if no script file is given (provocation)"
      run: ":\n"
      shell: "wsl-bash"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if no script file is given (verification)"
      run: "[ '${{ steps.no_script_file_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - id: "wrong_first_parameter_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if more than one parameter is given and first\
        \ is not -u (provocation)"
      run: ":\n"
      shell: "wsl-bash user {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if more than one parameter is given and first\
        \ is not -u (verification)"
      run: "[ '${{ steps.wrong_first_parameter_provocation.outcome }}' == 'failure'\
        \ ]\n"
      shell: "wsl-bash {0}"
    - id: "only_user_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if only user is given (provocation)"
      run: ":\n"
      shell: "wsl-bash -u {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if only user is given (verification)"
      run: "[ '${{ steps.only_user_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - id: "excess_argument_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if excess argument is given (provocation)"
      run: ":\n"
      shell: "wsl-bash -u user {0} foo"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if excess argument is given (verification)"
      run: "[ '${{ steps.excess_argument_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - id: "script_file_does_not_exist_provocation"
      if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if given script file does not exist (provocation)"
      run: ":\n"
      shell: "wsl-bash -u user {0}foo"
      continue-on-error: true
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - wsl-bash should fail if given script file does not exist (verification)"
      run: "[ '${{ steps.script_file_does_not_exist_provocation.outcome }}' == 'failure'\
        \ ]\n"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
      fail-fast: false
  "test":
    name: "Test \"${{ matrix.distribution.user-id }}\" distribution on ${{ matrix.environment\
      \ }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action1"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "use-cache": "false"
    - id: "no_default_bash_provocation"
      if: "matrix.distribution.user-id == 'Alpine'"
      name: "Test - wsl-bash should fail if bash is not present by default (provocation)"
      run: ":\n"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Test - wsl-bash should fail if bash is not present by default (verification)"
      run: "wsl sh -euc \"[ '${{ steps.no_default_bash_provocation.outcome }}' = 'failure'\
        \ ]\"\n"
    - if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action1.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "execute_action2"
      if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Install Bash on Alpine"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "bash"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should be available as custom shell"
      run: ":\n"
      shell: "wsl-bash {0}"
    - id: "wrapper_should_fail_provocation"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if the script fails (provocation)"
      run: "false\n"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if the script fails (verification)"
      run: "IF '${{ steps.wrapper_should_fail_provocation.outcome }}' NEQ 'failure'\
        \ EXIT /B 1\n"
      shell: "cmd"
    - id: "set_e_provocation"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if one of the commands fails (provocation)"
      run: "false\n:\n"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if one of the commands fails (verification)"
      run: "[ '${{ steps.set_e_provocation.outcome }}' == 'failure' ] || exit 1\n"
      shell: "wsl-bash {0}"
    - id: "set_u_provocation"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if an undefined variable is used (provocation)"
      run: "$foo"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if an undefined variable is used (verification)"
      run: "[ '${{ steps.set_u_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - id: "set_pipefail_provocation"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if any command in a pipe fails (provocation)"
      run: "false | true"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should fail if any command in a pipe fails (verification)"
      run: "[ '${{ steps.set_pipefail_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - the default distribution should be correct"
      run: "wslconfig.exe /list | iconv -f UTF-16LE -t UTF-8\n[[ \"$(wslconfig.exe\
        \ /list | iconv -f UTF-16LE -t UTF-8)\" == *${{ matrix.distribution.wsl-id\
        \ }}\\ \\(Default\\)* ]]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash should use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distribution.match-pattern }} ]]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - multi-line commands should not be disturbed by CRLF line endings"
      run: ": # this comment catches the CR if present\n! grep -q $'\\r' \"$0\" #\
        \ this comment catches the CR if present\n"
      shell: "wsl-bash {0}"
    - id: "default_absent_tool_absent_provocation"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - ${{ matrix.distribution.default-absent-tool }} should not be installed\
        \ by default (provocation)"
      run: "${{ matrix.distribution.default-absent-tool }} --version"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - ${{ matrix.distribution.default-absent-tool }} should not be installed\
        \ by default (verification)"
      run: "[ '${{ steps.default_absent_tool_absent_provocation.outcome }}' == 'failure'\
        \ ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - bash should be installed by default"
      run: "bash -c true"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - sh should be installed by default"
      run: "sh -c true"
      shell: "wsl-bash {0}"
    - id: "wsl-sh_absent_provocation"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-sh should not be present (provocation)"
      run: ":\n"
      shell: "wsl-sh {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-sh should not be present (verification)"
      run: "[ '${{ steps.wsl-sh_absent_provocation.outcome }}' == 'failure' ]\n"
      shell: "wsl-bash {0}"
    - id: "execute_action3"
      name: "Add wsl-sh wrapper"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "wsl-shell-command": "sh -eu"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - wsl-sh should be present"
      run: ":\n"
      shell: "wsl-sh {0}"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - wsl-bash should use bash"
      run: "ps -o pid='' -o comm='' | grep \"^\\s\\+$$\\s\\+\" | grep -o '\\S\\+$'\n\
        [ \"$(ps -o pid='' -o comm='' 2>/dev/null | grep \"^\\s\\+$$\\s\\+\" | grep\
        \ -o '\\S\\+$')\" == 'bash' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - wsl-sh should use sh"
      run: "ps -o pid='' -o comm='' | grep \"^\\s\\+$$\\s\\+\" | grep -o '\\S\\+$'\n\
        [ \"$(ps -o pid='' -o comm='' 2>/dev/null | grep \"^\\s\\+$$\\s\\+\" | grep\
        \ -o '\\S\\+$')\" = 'sh' ]\n"
      shell: "wsl-sh {0}"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action1.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "wsl-bash_absent_provocation"
      if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - wsl-bash should not be present (provocation)"
      run: ":\n"
      shell: "wsl-bash {0}"
      continue-on-error: true
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - wsl-bash should not be present (verification)"
      run: "[ '${{ steps.wsl-bash_absent_provocation.outcome }}' = 'failure' ]\n"
      shell: "wsl-sh {0}"
    - id: "execute_action4"
      name: "Re-add wsl-bash wrapper"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - wsl-bash should be present"
      run: ":\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - wsl-bash should use bash"
      run: "ps -o pid='' -o comm='' | grep \"^\\s\\+$$\\s\\+\" | grep -o '\\S\\+$'\n\
        [ \"$(ps -o pid='' -o comm='' 2>/dev/null | grep \"^\\s\\+$$\\s\\+\" | grep\
        \ -o '\\S\\+$')\" == 'bash' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - wsl-bash should use root as default user"
      run: "whoami\n[ \"$(whoami)\" == 'root' ]\n"
      shell: "wsl-bash {0}"
    - name: "Add user test"
      run: "useradd -m -p 4qBD5NWD3IkbU test\n"
      shell: "wsl-bash {0}"
    - id: "execute_action5"
      name: "Set wsl-bash wrapper to use user test by default"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "sudo"
        "wsl-shell-command": "bash -c \"sudo -u test bash --noprofile --norc -euo\
          \ pipefail \"\\"
    - if: "always() && (steps.execute_action5.outcome == 'success')"
      name: "Test - wsl-bash should use test as default user"
      run: "whoami\n[ \"$(whoami)\" == 'test' ]\n"
      shell: "wsl-bash {0}"
    - id: "execute_action6"
      name: "Set wsl-bash wrapper to use user test by default with inline script usage"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "wsl-shell-command": "bash -c \"sudo -u test bash --noprofile --norc -euo\
          \ pipefail '{0}'\""
    - if: "always() && (steps.execute_action6.outcome == 'success')"
      name: "Test - wsl-bash should use test as default user with inline script usage"
      run: "whoami\n[ \"$(whoami)\" == 'test' ]\n"
      shell: "wsl-bash {0}"
    - name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action6.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "execute_action7"
      name: "Set wsl-bash wrapper to use default user by default"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
    - if: "always() && (steps.execute_action7.outcome == 'success')"
      name: "Test - wsl-bash should use root as default user"
      run: "whoami\n[ \"$(whoami)\" == 'root' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action7.outcome == 'success')"
      name: "Test - test user does already exist"
      run: "id -u test\n"
      shell: "wsl-bash {0}"
    - name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action7.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "execute_action8"
      name: "Set wsl-bash wrapper to use existing user test by default with extra\
        \ parameter"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "wsl-shell-user": "test"
    - if: "always() && (steps.execute_action8.outcome == 'success')"
      name: "Test - wsl-bash should use existing user test as default user with extra\
        \ parameter"
      run: "whoami\n[ \"$(whoami)\" == 'test' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action8.outcome == 'success')"
      name: "Test - test2 user does not exist"
      run: "! id -u test2\n"
      shell: "wsl-bash {0}"
    - name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action8.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "execute_action9"
      name: "Set wsl-bash wrapper to use non-existing user test2 by default with extra\
        \ parameter"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "wsl-shell-user": "test2"
    - if: "always() && (steps.execute_action9.outcome == 'success')"
      name: "Test - wsl-bash should use auto-generated user test2 as default user"
      run: "whoami\n[ \"$(whoami)\" == 'test2' ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action9.outcome == 'success')"
      name: "Test - wsl-bash should use ad-hoc user test"
      run: "whoami\n[ \"$(whoami)\" == 'test' ]\n"
      shell: "wsl-bash -u test {0}"
    - if: "always() && (steps.execute_action9.outcome == 'success')"
      name: "Test - wsl-bash should use ad-hoc user root"
      run: "whoami\n[ \"$(whoami)\" == 'root' ]\n"
      shell: "wsl-bash -u root {0}"
    - id: "execute_action10"
      name: "Make a no-op execution of the action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
    - if: "always() && (steps.execute_action10.outcome == 'success')"
      name: "Test - wsl-bash should still use test2 as default user"
      run: "whoami\n[ \"$(whoami)\" == 'test2' ]\n"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Alpine"
          "user-id": "Alpine"
          "match-pattern": "*Alpine*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "kali-linux"
          "user-id": "kali-linux"
          "match-pattern": "*Kali*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "openSUSE-Leap-15.2"
          "user-id": "openSUSE-Leap-15.2"
          "match-pattern": "*openSUSE*Leap*15.2*"
          "default-absent-tool": "which"
        - "wsl-id": "Ubuntu-22.04"
          "user-id": "Ubuntu-22.04"
          "match-pattern": "*Ubuntu*22.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu"
          "user-id": "Ubuntu-20.04"
          "match-pattern": "*Ubuntu*20.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-18.04"
          "user-id": "Ubuntu-18.04"
          "match-pattern": "*Ubuntu*18.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-16.04"
          "user-id": "Ubuntu-16.04"
          "match-pattern": "*Ubuntu*16.04*"
          "default-absent-tool": "dos2unix"
      fail-fast: false
  "test_wsl-conf_on_initial_execution":
    name: "Test /etc/wsl.conf handling on initial execution for \"${{ matrix.distribution.user-id\
      \ }}\" distribution on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action1"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "wsl-conf": "[automount]\noptions = uid=1000\n"
    - if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action1.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "execute_action2"
      if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Install Bash on Alpine"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "bash"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - /etc/wsl.conf should exist"
      run: "[ -f /etc/wsl.conf ]\ncat /etc/wsl.conf\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - /mnt/c should be mounted with uid 1000"
      run: "ls -alh /mnt\n[[ \"$(stat -c %u /mnt/c)\" == 1000 ]]\n"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Alpine"
          "user-id": "Alpine"
          "match-pattern": "*Alpine*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "kali-linux"
          "user-id": "kali-linux"
          "match-pattern": "*Kali*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "openSUSE-Leap-15.2"
          "user-id": "openSUSE-Leap-15.2"
          "match-pattern": "*openSUSE*Leap*15.2*"
          "default-absent-tool": "which"
        - "wsl-id": "Ubuntu-22.04"
          "user-id": "Ubuntu-22.04"
          "match-pattern": "*Ubuntu*22.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu"
          "user-id": "Ubuntu-20.04"
          "match-pattern": "*Ubuntu*20.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-18.04"
          "user-id": "Ubuntu-18.04"
          "match-pattern": "*Ubuntu*18.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-16.04"
          "user-id": "Ubuntu-16.04"
          "match-pattern": "*Ubuntu*16.04*"
          "default-absent-tool": "dos2unix"
      fail-fast: false
  "test_wsl-conf_on_subsequent_execution":
    name: "Test /etc/wsl.conf handling on subsequent execution for \"${{ matrix.distribution.user-id\
      \ }}\" distribution on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action1"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
    - if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Delete wsl-bash"
      run: "DEL /F \"${{ steps.execute_action1.outputs.wsl-shell-wrapper-path }}\""
      shell: "cmd"
    - id: "execute_action2"
      if: "always() && (matrix.distribution.user-id == 'Alpine') && (steps.execute_action1.outcome\
        \ == 'success')"
      name: "Install Bash on Alpine"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "bash"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - /etc/wsl.conf should not exist"
      run: "[ ! -f /etc/wsl.conf ]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - C: should be mounted at /mnt/c\n"
      run: "mount\nmount | grep 'C:.* on /mnt/c'\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - /mnt/c should be mounted with uid 0"
      run: "ls -alh /mnt\n[[ \"$(stat -c %u /mnt/c)\" == 0 ]]\n"
      shell: "wsl-bash {0}"
    - id: "execute_action3"
      if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "wsl-conf": "[automount]\nroot = /\n"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - /etc/wsl.conf should exist"
      run: "[ -f /etc/wsl.conf ]\ncat /etc/wsl.conf\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - C: should be mounted at /c\n"
      run: "mount\nmount | grep 'C:.* on /c'\n"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Alpine"
          "user-id": "Alpine"
          "match-pattern": "*Alpine*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "kali-linux"
          "user-id": "kali-linux"
          "match-pattern": "*Kali*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "openSUSE-Leap-15.2"
          "user-id": "openSUSE-Leap-15.2"
          "match-pattern": "*openSUSE*Leap*15.2*"
          "default-absent-tool": "which"
        - "wsl-id": "Ubuntu-22.04"
          "user-id": "Ubuntu-22.04"
          "match-pattern": "*Ubuntu*22.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu"
          "user-id": "Ubuntu-20.04"
          "match-pattern": "*Ubuntu*20.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-18.04"
          "user-id": "Ubuntu-18.04"
          "match-pattern": "*Ubuntu*18.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-16.04"
          "user-id": "Ubuntu-16.04"
          "match-pattern": "*Ubuntu*16.04*"
          "default-absent-tool": "dos2unix"
      fail-fast: false
  "test_additional_packages":
    name: "Test additional packages for \"${{ matrix.distribution.user-id }}\" distribution\
      \ on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "${{ matrix.distribution.default-absent-tool }} bash\n"
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - ${{ matrix.distribution.default-absent-tool }} should be installed"
      run: "${{ matrix.distribution.default-absent-tool }} --version"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action.outcome == 'success')"
      name: "Test - bash should be installed"
      run: "bash -c true"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Alpine"
          "user-id": "Alpine"
          "match-pattern": "*Alpine*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "kali-linux"
          "user-id": "kali-linux"
          "match-pattern": "*Kali*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "openSUSE-Leap-15.2"
          "user-id": "openSUSE-Leap-15.2"
          "match-pattern": "*openSUSE*Leap*15.2*"
          "default-absent-tool": "which"
        - "wsl-id": "Ubuntu-22.04"
          "user-id": "Ubuntu-22.04"
          "match-pattern": "*Ubuntu*22.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu"
          "user-id": "Ubuntu-20.04"
          "match-pattern": "*Ubuntu*20.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-18.04"
          "user-id": "Ubuntu-18.04"
          "match-pattern": "*Ubuntu*18.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-16.04"
          "user-id": "Ubuntu-16.04"
          "match-pattern": "*Ubuntu*16.04*"
          "default-absent-tool": "dos2unix"
      fail-fast: false
  "test_multiple_usage_with_different_distributions":
    name: "Test multiple usage with different distributions (\"${{ matrix.distributions.distribution1.user-id\
      \ }}\" / \"${{ matrix.distributions.distribution2.user-id }}\" / \"${{ matrix.distributions.distribution3.user-id\
      \ }}\") on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action1"
      name: "Execute action for ${{ matrix.distributions.distribution1.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution1.user-id }}"
    - id: "execute_action2"
      name: "Execute action for ${{ matrix.distributions.distribution2.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution2.user-id }}"
    - id: "execute_action3"
      name: "Execute action for ${{ matrix.distributions.distribution3.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution3.user-id }}"
        "set-as-default": "false"
    - id: "execute_action4"
      name: "Execute action for ${{ matrix.distributions.distribution1.user-id }}\
        \ again"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution1.user-id }}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - the default distribution should be the last installed distribution\
        \ with set-as-default true"
      run: "wslconfig.exe /list\nwslconfig.exe /list | iconv -f UTF-16LE -t UTF-8\n\
        [[ \"$(wslconfig.exe /list | iconv -f UTF-16LE -t UTF-8)\" == *${{ matrix.distributions.distribution2.wsl-id\
        \ }}\\ \\(Default\\)* ]]\n"
      shell: "wsl-bash {0}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - wsl-bash should use the last installed distribution with set-as-default\
        \ true"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution2.match-pattern }} ]]\n"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distributions":
        - "distribution1":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
        - "distribution1":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
        - "distribution1":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
        - "distribution1":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
        - "distribution1":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
        - "distribution1":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
      fail-fast: false
  "test_multiple_usage_with_same_distribution":
    name: "Test multiple usage with \"${{ matrix.distribution.user-id }}\" distribution\
      \ on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action1"
      name: "Execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "bash"
    - id: "execute_action2"
      if: "matrix.distribution.user-id != 'kali-linux'"
      name: "Update distribution"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "update": "true"
    - id: "execute_action3"
      name: "Install default absent tool"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "additional-packages": "${{ matrix.distribution.default-absent-tool }}"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - ${{ matrix.distribution.default-absent-tool }} should be installed"
      run: "${{ matrix.distribution.default-absent-tool }} --version"
      shell: "wsl-bash {0}"
    - id: "execute_action4"
      name: "Execute action for ${{ matrix.distribution2.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution2.user-id }}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - \"${{ matrix.distribution2.user-id }}\" should be the default\
        \ distribution after installation"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distribution2.match-pattern }} ]]\n"
      shell: "wsl-bash {0}"
    - id: "execute_action5"
      name: "Re-execute action"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
    - if: "always() && (steps.execute_action5.outcome == 'success')"
      name: "Test - \"${{ matrix.distribution2.user-id }}\" should still be the default\
        \ distribution after re-running for \"${{ matrix.distribution.user-id }}\""
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distribution2.match-pattern }} ]]\n"
      shell: "wsl-bash {0}"
    - id: "execute_action6"
      name: "Set as default"
      uses: "./"
      with:
        "distribution": "${{ matrix.distribution.user-id }}"
        "set-as-default": "true"
    - if: "always() && (steps.execute_action6.outcome == 'success')"
      name: "Test - \"${{ matrix.distribution.user-id }}\" should be the default distribution\
        \ after re-running with set-as-default true"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distribution.match-pattern }} ]]\n"
      shell: "wsl-bash {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distribution":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Alpine"
          "user-id": "Alpine"
          "match-pattern": "*Alpine*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "kali-linux"
          "user-id": "kali-linux"
          "match-pattern": "*Kali*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "openSUSE-Leap-15.2"
          "user-id": "openSUSE-Leap-15.2"
          "match-pattern": "*openSUSE*Leap*15.2*"
          "default-absent-tool": "which"
        - "wsl-id": "Ubuntu-22.04"
          "user-id": "Ubuntu-22.04"
          "match-pattern": "*Ubuntu*22.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu"
          "user-id": "Ubuntu-20.04"
          "match-pattern": "*Ubuntu*20.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-18.04"
          "user-id": "Ubuntu-18.04"
          "match-pattern": "*Ubuntu*18.04*"
          "default-absent-tool": "dos2unix"
        - "wsl-id": "Ubuntu-16.04"
          "user-id": "Ubuntu-16.04"
          "match-pattern": "*Ubuntu*16.04*"
          "default-absent-tool": "dos2unix"
        "distribution2":
        - "wsl-id": "Debian"
          "user-id": "Debian"
          "match-pattern": "*Debian*"
          "default-absent-tool": "dos2unix"
        "exclude":
        - "environment": "windows-2019"
          "distribution":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
        - "environment": "windows-2022"
          "distribution":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
        - "environment": "windows-latest"
          "distribution":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
        "include":
        - "environment": "windows-2019"
          "distribution":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
        - "environment": "windows-2022"
          "distribution":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
        - "environment": "windows-latest"
          "distribution":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
      fail-fast: false
  "test_distribution_specific_wsl_bash_scripts":
    name: "Test distribution specific wsl-bash scripts on ${{ matrix.environment }}"
    needs: "build"
    runs-on: "${{ matrix.environment }}"
    steps:
    - name: "Restore built artifacts from cache"
      uses: "actions/cache@v2"
      with:
        "path": "action.yml\nbuild/distributions/\n"
        "key": "${{ github.run_id }}"
    - id: "execute_action1"
      name: "Execute action for ${{ matrix.distributions.distribution1.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution1.user-id }}"
    - id: "execute_action2"
      name: "Execute action for ${{ matrix.distributions.distribution2.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution2.user-id }}"
        "additional-packages": "bash"
    - id: "execute_action3"
      name: "Execute action for ${{ matrix.distributions.distribution3.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution3.user-id }}"
        "set-as-default": "false"
    - id: "execute_action4"
      name: "Execute action for ${{ matrix.distributions.distribution4.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution4.user-id }}"
        "set-as-default": "false"
    - id: "execute_action5"
      name: "Execute action for ${{ matrix.distributions.distribution5.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution5.user-id }}"
        "set-as-default": "false"
    - id: "execute_action6"
      name: "Execute action for ${{ matrix.distributions.distribution6.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution6.user-id }}"
        "set-as-default": "false"
    - id: "execute_action7"
      name: "Execute action for ${{ matrix.distributions.distribution7.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution7.user-id }}"
        "set-as-default": "false"
    - id: "execute_action8"
      name: "Execute action for ${{ matrix.distributions.distribution8.user-id }}"
      uses: "./"
      with:
        "distribution": "${{ matrix.distributions.distribution8.user-id }}"
        "set-as-default": "false"
    - if: "always() && (steps.execute_action1.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution1.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution1.match-pattern }} ]]\n"
      shell: "wsl-bash_Debian {0}"
    - if: "always() && (steps.execute_action2.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution2.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution2.match-pattern }} ]]\n"
      shell: "wsl-bash_Alpine {0}"
    - if: "always() && (steps.execute_action3.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution3.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution3.match-pattern }} ]]\n"
      shell: "wsl-bash_kali-linux {0}"
    - if: "always() && (steps.execute_action4.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution4.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution4.match-pattern }} ]]\n"
      shell: "wsl-bash_openSUSE-Leap-15.2 {0}"
    - if: "always() && (steps.execute_action5.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution5.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution5.match-pattern }} ]]\n"
      shell: "wsl-bash_Ubuntu-22.04 {0}"
    - if: "always() && (steps.execute_action6.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution6.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution6.match-pattern }} ]]\n"
      shell: "wsl-bash_Ubuntu-20.04 {0}"
    - if: "always() && (steps.execute_action7.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution7.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution7.match-pattern }} ]]\n"
      shell: "wsl-bash_Ubuntu-18.04 {0}"
    - if: "always() && (steps.execute_action8.outcome == 'success')"
      name: "Test - wsl-bash_${{ matrix.distributions.distribution8.user-id }} should\
        \ use the correct distribution"
      run: "cat <(lsb_release -a || true) <(uname -a || true) <([ -d /etc ] && find\
        \ /etc -maxdepth 1 -type f \\( -name '*release' -or -name 'issue*' \\) -exec\
        \ cat {} + || true) <([ -d /etc/products.d ] && find /etc/products.d -maxdepth\
        \ 1 -type f -name '*.prod' -exec cat {} + || true) <([ -f /proc/version ]\
        \ && cat /proc/version || true)\n[[ \"$(cat <(lsb_release -a || true) <(uname\
        \ -a || true) <([ -d /etc ] && find /etc -maxdepth 1 -type f \\( -name '*release'\
        \ -or -name 'issue*' \\) -exec cat {} + || true) <([ -d /etc/products.d ]\
        \ && find /etc/products.d -maxdepth 1 -type f -name '*.prod' -exec cat {}\
        \ + || true) <([ -f /proc/version ] && cat /proc/version || true))\" == ${{\
        \ matrix.distributions.distribution8.match-pattern }} ]]\n"
      shell: "wsl-bash_Ubuntu-16.04 {0}"
    strategy:
      matrix:
        "environment":
        - "windows-2019"
        - "windows-2022"
        - "windows-latest"
        "distributions":
        - "distribution1":
            "wsl-id": "Debian"
            "user-id": "Debian"
            "match-pattern": "*Debian*"
            "default-absent-tool": "dos2unix"
          "distribution2":
            "wsl-id": "Alpine"
            "user-id": "Alpine"
            "match-pattern": "*Alpine*"
            "default-absent-tool": "dos2unix"
          "distribution3":
            "wsl-id": "kali-linux"
            "user-id": "kali-linux"
            "match-pattern": "*Kali*"
            "default-absent-tool": "dos2unix"
          "distribution4":
            "wsl-id": "openSUSE-Leap-15.2"
            "user-id": "openSUSE-Leap-15.2"
            "match-pattern": "*openSUSE*Leap*15.2*"
            "default-absent-tool": "which"
          "distribution5":
            "wsl-id": "Ubuntu-22.04"
            "user-id": "Ubuntu-22.04"
            "match-pattern": "*Ubuntu*22.04*"
            "default-absent-tool": "dos2unix"
          "distribution6":
            "wsl-id": "Ubuntu"
            "user-id": "Ubuntu-20.04"
            "match-pattern": "*Ubuntu*20.04*"
            "default-absent-tool": "dos2unix"
          "distribution7":
            "wsl-id": "Ubuntu-18.04"
            "user-id": "Ubuntu-18.04"
            "match-pattern": "*Ubuntu*18.04*"
            "default-absent-tool": "dos2unix"
          "distribution8":
            "wsl-id": "Ubuntu-16.04"
            "user-id": "Ubuntu-16.04"
            "match-pattern": "*Ubuntu*16.04*"
            "default-absent-tool": "dos2unix"
      fail-fast: false